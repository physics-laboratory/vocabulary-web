<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>English Vocab Helper</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22c55e;
      --border: #1f2937;
    }
    body {
      margin: 0; padding: 24px;
      background: linear-gradient(180deg, #0b1220, #0f172a 50%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .container { max-width: 1000px; margin: auto; }
    h1 { font-size: 28px; margin-bottom: 16px; }
    .panel {
      background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(6px);
      border: 1px solid var(--border); border-radius: 16px; padding: 16px;
      margin-bottom: 16px;
    }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 16px; }
    input[type="text"], input[type="email"], input[type="password"] {
      width: 100%; padding: 12px; border-radius: 12px;
      border: 1px solid var(--border); background: #0b1220; color: var(--text);
    }
    button {
      padding: 12px 16px; border: none; cursor: pointer;
      border-radius: 12px; background: var(--accent); color: #052e16;
      font-weight: 700;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px; border-top: 1px solid var(--border); }
    th { background: #0b1220; color: #cbd5e1; text-align: left; }
    .status { margin-top: 8px; font-size: 14px; color: var(--muted); }
    .err { color: #fca5a5; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📚 Vocabulary Helper</h1>

    <!-- Form login/signup -->
    <div class="panel" id="auth-panel">
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <div class="row">
        <button id="signup-btn">Sign Up</button>
        <button id="login-btn">Login</button>
        <button id="logout-btn" style="display:none;">Logout</button>
      </div>
      <div id="auth-status" class="status"></div>
    </div>

    <!-- Panel tra từ -->
    <div class="panel" id="main-panel" style="display:none;">
      <div class="row">
        <input id="word-input" type="text" placeholder="Nhập từ tiếng Anh..." />
        <button id="add-btn">Thêm từ</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Word</th>
            <th>Definition</th>
            <th>Means (VI)</th>
            <th>Example</th>
          </tr>
        </thead>
        <tbody id="vocab-body"></tbody>
      </table>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    // 🚀 Supabase config
    const SUPABASE_URL = "YOUR_PROJECT_URL";
    const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    const input = document.getElementById("word-input");
    const tbody = document.getElementById("vocab-body");
    const statusEl = document.getElementById("status");
    const authStatus = document.getElementById("auth-status");

    function setStatus(msg, err=false) {
      statusEl.textContent = msg;
      statusEl.className = "status" + (err ? " err" : "");
    }
    function setAuthStatus(msg, err=false) {
      authStatus.textContent = msg;
      authStatus.className = "status" + (err ? " err" : "");
    }

    // ✅ Sign Up
    document.getElementById("signup-btn").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return setAuthStatus("Email và mật khẩu không được trống!", true);
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) return setAuthStatus(error.message, true);
      setAuthStatus("Check email để xác nhận đăng ký!");
    };

    // ✅ Login
    document.getElementById("login-btn").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return setAuthStatus("Email và mật khẩu không được trống!", true);
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return setAuthStatus(error.message, true);
      currentUser = data.user;
      setAuthStatus("Đăng nhập thành công!");
      document.getElementById("main-panel").style.display = "block";
      document.getElementById("logout-btn").style.display = "inline-block";
      loadWords();
    };

    // ✅ Logout
    document.getElementById("logout-btn").onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      tbody.innerHTML = "";
      document.getElementById("main-panel").style.display = "none";
      document.getElementById("logout-btn").style.display = "none";
      setAuthStatus("Đã đăng xuất!");
    };

    // ✅ Add word
    document.getElementById("add-btn").onclick = async () => {
      const word = input.value.trim();
      if (!word) return setStatus("Nhập từ trước khi thêm!", true);
      if (!currentUser) return setStatus("Bạn phải đăng nhập!", true);
      setStatus("Đang tra từ…");

      try {
        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
        const dict = await res.json();
        if (!res.ok || !dict[0]) throw new Error("Không tìm thấy định nghĩa");
        const definition = dict[0].meanings[0].definitions[0].definition || "";
        const example = dict[0].meanings[0].definitions[0].example || "";

        const viRes = await fetch(`https://api.mymemory.translated.net/get?q=${word}&langpair=en|vi`);
        const viJson = await viRes.json();
        const vietnamese = viJson.responseData.translatedText || "";

        const { error } = await supabase.from("user_words").insert([{
          user_id: currentUser.id,
          word, definition, meaning_vi: vietnamese, example
        }]);
        if (error) throw error;

        addRow({ word, definition, vietnamese, example });
        setStatus("Đã thêm từ!");
        input.value = "";
      } catch (err) {
        console.error(err);
        setStatus("Lỗi khi tra từ hoặc lưu!", true);
      }
    };

    // ✅ Load words
    async function loadWords() {
      if (!currentUser) return;
      const { data, error } = await supabase.from("user_words").select("*").eq("user_id", currentUser.id);
      if (error) return setStatus(error.message, true);
      tbody.innerHTML = "";
      data.forEach(r => addRow({ word: r.word, definition: r.definition, vietnamese: r.meaning_vi, example: r.example }));
    }

    function addRow(w) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${w.word}</td>
        <td>${w.definition}</td>
        <td>${w.vietnamese}</td>
        <td>${w.example}</td>`;
      tbody.prepend(tr);
    }

    // Press Enter
    input.addEventListener("keydown", e => { if (e.key === "Enter") document.getElementById("add-btn").click(); });
  </script>
</body>
</html>
